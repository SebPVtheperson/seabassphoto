<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - seabass.photo</title>
  <style>
    * { box-sizing: border-box; }
    body {
      background: #008080;
      font-family: 'MS Sans Serif', sans-serif;
      margin: 0;
      padding: 2rem;
      color: black;
    }
    .container { max-width: 700px; margin: 0 auto; }
    .window {
      background: silver;
      border: 2px solid black;
      padding: 1rem;
      box-shadow: 4px 4px 0 #000;
      margin-bottom: 1.5rem;
    }
    h1 { margin: 0 0 1rem 0; font-size: 1.2rem; }
    .btn {
      padding: 0.4rem 0.8rem;
      font-family: inherit;
      font-weight: bold;
      background: #c0c0c0;
      border: 2px outset #e0e0e0;
      cursor: pointer;
      color: black;
    }
    .btn:hover { background: #a0a0a0; }
    .btn:active { border-style: inset; }
    .btn-small { padding: 0.2rem 0.5rem; font-size: 0.85rem; }
    input[type="text"], input[type="password"] {
      padding: 0.4rem;
      font-family: inherit;
      border: 2px inset #808080;
      width: 100%;
    }
    input { margin-bottom: 0.5rem; }
    label { display: block; font-weight: bold; margin-bottom: 0.2rem; }
    .row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
    .toggle { width: 40px; height: 22px; background: #888; border-radius: 11px; cursor: pointer; position: relative; flex-shrink: 0; }
    .toggle.on { background: #008000; }
    .toggle::after { content: ''; position: absolute; width: 18px; height: 18px; background: white; border: 1px solid #666; top: 1px; left: 1px; border-radius: 50%; transition: left 0.15s; }
    .toggle.on::after { left: 19px; }
    .gallery-row {
      background: #d4d0c8;
      border: 2px inset #808080;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .gallery-row .top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .gallery-row .slug { font-size: 0.8rem; color: #555; }
    .gallery-row .fields { display: grid; gap: 0.5rem; margin-top: 0.5rem; }
    .gallery-row input { margin-bottom: 0; }
    .error { color: #c00; margin: 0.5rem 0; }
    .success { color: #008000; margin: 0.5rem 0; }
    .back { color: white; text-decoration: none; margin-bottom: 1rem; display: inline-block; }
  </style>
</head>
<body>
  <div class="container">
    <a class="back" href="index.html">‚Üê Back to site</a>

    <div id="login-screen" class="window">
      <h1>üîê Admin Login</h1>
      <p id="login-error" class="error" style="display:none"></p>
      <label>Password</label>
      <input type="password" id="password" placeholder="Admin password">
      <br>
      <button class="btn" id="login-btn">Sign In</button>
    </div>

    <div id="admin-screen" style="display:none">
      <div class="window">
        <h1>üìÅ Galleries</h1>
        <p id="admin-error" class="error" style="display:none"></p>
        <p id="admin-success" class="success" style="display:none"></p>
        <div id="gallery-list"></div>
      </div>
    </div>
  </div>

  <script>
    const API = '/.netlify/functions';
    let token = sessionStorage.getItem('admin_token');

    function show(el, visible) { el.style.display = visible ? '' : 'none'; }
    function msg(el, text, isError) { el.textContent = text; el.style.display = text ? '' : 'none'; el.className = isError ? 'error' : 'success'; }

    async function login() {
      const password = document.getElementById('password').value;
      const errEl = document.getElementById('login-error');
      if (!password) { msg(errEl, 'Enter password', true); return; }
      try {
        const r = await fetch(API + '/admin-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password }),
        });
        let data;
        try {
          data = await r.json();
        } catch {
          if (r.status === 404) {
            msg(errEl, 'Admin not deployed yet. Push your code and wait for Netlify to deploy.', true);
            return;
          }
          msg(errEl, 'Server error (status ' + r.status + '). Check the deploy.', true);
          return;
        }
        if (data.token) {
          token = data.token;
          sessionStorage.setItem('admin_token', token);
          show(document.getElementById('login-screen'), false);
          show(document.getElementById('admin-screen'), true);
          loadGalleries();
        } else {
          msg(errEl, data.error || 'Login failed', true);
        }
      } catch (e) {
        msg(errEl, 'Cannot reach server. Are you on the live Netlify site? Try: ' + (e.message || 'network error'), true);
      }
    }

    function logout() {
      token = null;
      sessionStorage.removeItem('admin_token');
      show(document.getElementById('login-screen'), true);
      show(document.getElementById('admin-screen'), false);
      document.getElementById('password').value = '';
    }

    function authHeaders() {
      return { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };
    }

    async function loadGalleries() {
      try {
        const r = await fetch(API + '/admin-galleries', { headers: authHeaders() });
        if (r.status === 401) { logout(); return; }
        const data = await r.json();
        if (data.error) throw new Error(data.error);
        renderGalleries(data.galleries || []);
      } catch (e) {
        msg(document.getElementById('admin-error'), e.message || 'Failed to load', true);
      }
    }

    function renderGalleries(galleries) {
      const list = document.getElementById('gallery-list');
      list.innerHTML = galleries.map(g => `
        <div class="gallery-row" data-id="${g.id}">
          <div class="top">
            <span><strong>${escapeHtml(g.title)}</strong></span>
            <button class="btn btn-small save-btn" data-id="${g.id}">Save</button>
          </div>
          <div class="slug">${escapeHtml(g.slug)} ¬∑ ${(g.images || []).length} images</div>
          <div class="fields">
            <label><input type="checkbox" class="is-public" ${g.is_public ? 'checked' : ''}> Public</label>
            <label>Codeword (for private) <input type="text" class="codeword" value="${escapeHtml(g.codeword || '')}" placeholder="Leave blank if public"></label>
          </div>
        </div>
      `).join('');

      list.querySelectorAll('.save-btn').forEach(btn => {
        btn.onclick = () => saveGallery(btn.dataset.id);
      });
      list.querySelectorAll('.is-public').forEach(cb => {
        cb.onchange = () => { const row = cb.closest('.gallery-row'); row.querySelector('.codeword').disabled = cb.checked; };
      });
      list.querySelectorAll('.gallery-row').forEach(row => {
        const cb = row.querySelector('.is-public');
        row.querySelector('.codeword').disabled = cb.checked;
      });
    }

    function escapeHtml(s) {
      if (!s) return '';
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    async function saveGallery(id) {
      const row = document.querySelector(`.gallery-row[data-id="${id}"]`);
      const isPublic = row.querySelector('.is-public').checked;
      const codeword = row.querySelector('.codeword').value.trim();
      const errEl = document.getElementById('admin-error');
      const okEl = document.getElementById('admin-success');
      try {
        const r = await fetch(API + '/admin-galleries', {
          method: 'PATCH',
          headers: authHeaders(),
          body: JSON.stringify({ id, is_public: isPublic, codeword: isPublic ? null : codeword }),
        });
        if (r.status === 401) { logout(); return; }
        const data = await r.json();
        if (data.error) throw new Error(data.error);
        msg(errEl, '');
        msg(okEl, 'Saved!', false);
        setTimeout(() => msg(okEl, ''), 2000);
      } catch (e) {
        msg(errEl, e.message || 'Save failed', true);
      }
    }

    document.getElementById('login-btn').onclick = login;
    document.getElementById('password').onkeydown = e => { if (e.key === 'Enter') login(); };

    if (token) {
      show(document.getElementById('login-screen'), false);
      show(document.getElementById('admin-screen'), true);
      loadGalleries();
    }
  </script>
</body>
</html>
